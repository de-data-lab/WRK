---
title: "WRK Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: 
      version: 4
      primary: "#0c8ccd" #blue
      warning: "#ffc934" #yellow
      navbar-bg: "#00a454" #green
runtime: shiny
---


```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(readxl)
library(here)
library(shiny)
library(plotly)
library(patchwork)
library(lubridate)


source(here("utils/utils.R"))
source(here("utils/plot_achievement.R"))
source(here("utils/print_pct.R"))
source(here("utils/plotly_utils.R"))
source(here("utils/wrk_pal.R"))


## Load HUD Data 
# Data dictionary: https://www.huduser.gov/portal/datasets/pictures/dictionary_2021.pdf
# Number_reported is the same as the 
# hud_tracts_ak_mn_URL <- "https://www.huduser.gov/portal/datasets/pictures/files/TRACT_AK_MN_2019.xlsx"
hud_de <- read_rds(here("data/processed/hud_DE_combined.rds"))
# Estimate the number of occupied units
hud_de <- hud_de %>%
  mutate(occupied_units = case_when(pct_occupied == -4 ~ NA_real_,
                   TRUE ~ round(total_units * (pct_occupied/100), 0)))

# Target Census Tracts
target_tracts <- c("CT 30.02 (Riverside)" = "10003003002",
                   "CT 6.01" = "10003000601",
                   "CT 6.02" = "10003000602")

# Recode the missing values 
hud_de <- hud_de %>%
  mutate(across(where(is.numeric),
                ~na_if(., y = -1))) %>%
    mutate(across(where(is.numeric),
                ~na_if(., y = -4)))

# Load variable names
hud_vars_df <- read_excel(here("data/raw/hud_vars.xlsx"))
hud_vars <- hud_vars_df$variable
names(hud_vars) <- hud_vars_df$label

# Create a list of variable descriptions
hud_var_def <- hud_vars_df %>%
  select(variable, definition) %>%
  deframe()

# Set ggplot global theme
theme_set(theme_minimal())
```

# Housing {data-orientation=columns}
```{r}
# New available units for rent
# Calculate the Riverside metrics
riverside_total_units <- hud_de %>%
  filter(code == "10003003002") %>%
  select(year, total_units) %>%
  mutate(total_units_lag = lag(total_units)) %>%
  # Calculate the percent change
  mutate(pct_change = ((total_units/lag(total_units) - 1)) * 100)
# Mean percent change across years
riverside_total_units_pct_change_mean <- riverside_total_units %>%
  summarise(mean = mean(pct_change, na.rm = TRUE))

# Get the average number of units changed
riverside_total_units_lm <- riverside_total_units %>%
  lm(data = ., total_units ~ year)
riverside_total_units_coef <- coef(riverside_total_units_lm)[["year"]]

  
## Proportions of units occupied 
# Calculate the Riverside metrics
riverside_pct_occupied <- hud_de %>%
  filter(code == "10003003002") %>%
  transmute(year, pct_occupied, total_units) %>%
  mutate(location = "Riverside")

# Calcualate the Delaware average
DE_pct_occupied <- hud_de %>%
  group_by(year) %>%
  summarise(pct_occupied = mean(pct_occupied, na.rm = TRUE),
            total_units = sum(number_reported, na.rm = TRUE)) %>%
  mutate(location = "Delaware")

# Join the tables 
pct_occupied_joined <- riverside_pct_occupied %>%
  bind_rows(DE_pct_occupied)

# Calculate the average year-to-year change in pct_occupied
pct_occupied_joined_lm <- riverside_pct_occupied %>%
  lm(data = ., pct_occupied ~ year)
## If we are adjusting for the total_units:
# pct_occupied_joined_lm <- riverside_pct_occupied %>%
#   lm(data = ., pct_occupied ~ year + total_units)  

# Get the coefficient 
pct_occupied_riverside_change <- coef(pct_occupied_joined_lm)[["year"]]
```


Column 1: Available Rental Units
-----------------------------------------------------------------------
### Change in available units for rent

```{r}
total_units_change_box_text <- riverside_total_units_coef %>%
  round(1) %>%
  paste0("/year")

valueBox(total_units_change_box_text, icon = "fa-building")
```


### Available rental units
```{r}
# Create a plot for 
riverside_rental_units_plot <- riverside_total_units %>%
  ggplot(aes(x = year, y = total_units)) +
  geom_col(fill = get_wrk_color("green")) +
  labs(title = "Rental units available in Riverside",
       y = NULL, x = NULL) +
  theme_minimal()

riverside_rental_changes_plot <- riverside_total_units %>%
  drop_na(pct_change) %>%
  ggplot(aes(x = year, y = pct_change)) + 
  geom_line(color = get_wrk_color("green")) + 
  geom_point(color = get_wrk_color("green")) +
  scale_y_continuous(labels = ~paste0(., "%"),
                     breaks = scales::breaks_pretty()) +
  labs(title = "Changes in available units",
       y = NULL, x = NULL) +
  theme_minimal()
```

```{r}
renderPlot({riverside_rental_units_plot / riverside_rental_changes_plot},
           res = 80)
```


Column 2: Occupied units
-----------------------------------------------------------------------

### Average change in proportion of occupied units

```{r}
# Get the text to be rendered
pct_occupied_box_text <- pct_occupied_riverside_change %>% 
  round(1) %>%
  paste0("%/year")
# Change color of the infobox depending on direction
pct_occupied_color <- case_when(pct_occupied_riverside_change >= 0 ~ "success",
                                TRUE ~ "warning")
# Render the valuebox
valueBox(pct_occupied_box_text,
         icon = "fas fa-house-user", 
         color = pct_occupied_color)
```

### Occupied Units

```{r}
# Generate a hovertext for plotting  
pct_occupied_joined <- pct_occupied_joined %>%
  mutate(hovertext = str_glue("{round(pct_occupied, 1)}% of units in {location} were occupied in {year} \n (Out of {total_units} units)"))

# Create a plotly plot
pct_occupied_plot <- pct_occupied_joined %>%
  plot_ly(x = ~year, y = ~pct_occupied, text = ~location) %>%
  add_trace(type = "scatter", 
            mode = "markers+lines",
            color = ~location,
            hoveron = "points",
            hovertext = ~hovertext,
            hoverinfo = "text",
            colors = wrk_pal()(2)) %>%
  # Add annotations for Riverside vs. Wilmington
  add_annotations(x = 2018, y = 97,
                  text = "Riverside",
                  font = list(color = get_wrk_color("green"),
                              size = 14),
                  showarrow = FALSE) %>% 
  add_annotations(x = 2020, y = 91,
                  text = "Delaware",
                  font = list(color = get_wrk_color("blue"),
                              size = 14),
                  showarrow = FALSE) %>% 
  # Add caption 
  add_annotations(x = 1, y = -0.06,
                  text = "Source: <a href='https://www.huduser.gov/portal/datasets/assthsg.html' target='_blank'>HUD</a>",
                  showarrow = FALSE, xref ="paper", yref = "paper", 
                  xanchor = "right", yanchor = "auto") %>%
  # Remove axis labels since they are obvious
  # Add "%" suffix to the y-axis
  layout(yaxis = list(title = "",
                      ticksuffix = "%"),
         xaxis = list(title = ""),
         title = list(text = "Rental units occupied (%)",
                      xanchor = "left", x = 0)) %>% 
  hide_legend() %>% 
  plotly_hide_modebar() %>%
  plotly_disable_zoom() 

# Render Plot
renderPlotly({pct_occupied_plot })
```


Column 3: Months since move-in
-----------------------------------------------------------------------

### Average months since moved in

```{r}
# Average months since moved in
riverside_tenure <- hud_de %>%
    filter(code == "10003003002") %>%
  select(year, months_from_movein, pct_occupied, total_units) %>%
  mutate(location = "riverside")

DE_tenure <- hud_de %>%
  group_by(year) %>%
  summarise(months_from_movein = mean(months_from_movein, na.rm = TRUE),
            pct_occupied = mean(pct_occupied, na.rm = TRUE),
            total_units = mean(total_units, na.rm = TRUE)) %>%
  mutate(location = "DE")

# Combine the Riverside and DE data
tenure_stacked <- riverside_tenure %>%
  bind_rows(DE_tenure)

# Calculate the average change in tenure for Riverside
riverside_tenure_lm <- riverside_tenure %>%
  lm(data = ., months_from_movein ~ year)

riverside_tenure_coef <- coef(riverside_tenure_lm)[["year"]]

riverside_tenure_text <- riverside_tenure_coef %>%
  round(1) %>%
  sprintf("%+.1fmo/year", .)

valueBox(riverside_tenure_text, icon = "fas fa-calendar-alt")
```

### Average months since moved in

```{r}
tenure_plot <- tenure_stacked %>%
  ggplot(aes(x = year, y = months_from_movein,
             color = location)) + 
  geom_line() + 
  geom_point() +
    scale_color_manual(values = wrk_pal()(2)) +
    annotate("text", x = 2018, y = 110, label = "Riverside",
           color = get_wrk_color("green")) +
  annotate("text", x = 2020, y = 105, label = "Delaware",
           color = get_wrk_color("blue")) +
  theme_minimal() + 
  labs(x = NULL, y = NULL,
       title = "Months since moved in") +
  guides(color = "none")

renderPlot({tenure_plot}, res = 100)

```



# Education {data-orientation=columns}
```{r}
kinder_readiness_DE_wide <- read_rds(here("data/processed/education_kinder_readiness_wide.rds"))
DE_kinder <- kinder_readiness_DE_wide %>%
  transmute(year = TimeFrame,location = Location,
            kinder_ready_prop = mean)

WRK_wide <-
read_rds(here("data/processed/education_kinder_readiness_WRK.rds"))

WRK_kinder <- WRK_wide %>%
  transmute(year = year, location = "WRK",
            kinder_ready_prop = kinder_ready_prop)

all_kinder <- DE_kinder %>%
  bind_rows(WRK_kinder)

# Calculate the readiness average over years
kinder_WRK_DE_comparison <- all_kinder %>%
  group_by(location) %>%
  summarise(mean = mean(kinder_ready_prop))

# Create a text vector for printing out
kinder_txt <- kinder_WRK_DE_comparison %>%
  mutate(mean = sprintf("%.1f%%", mean * 100)) %>%
  deframe() %>% as.list()

# Calculate percentage increase between two perccentages
kinder_WRK_DE_comparison_list <- kinder_WRK_DE_comparison %>%
  deframe() %>% as.list()
kinder_pct_diff <- (kinder_WRK_DE_comparison_list$WRK - kinder_WRK_DE_comparison_list$Delaware) /
  kinder_WRK_DE_comparison_list$Delaware
```


```{r}
# Load Graduation Data
graduation <- read_rds(here("data/processed/workforce_graduation.rds"))
graduation_gaps <- read_rds(here("data/processed/workforce_graduation_gaps.rds"))

# Calculate statics for graduation
# Graduation: Assume linear trend and calculate an average change
graduation_gaps_lm <- lm(data = graduation_gaps,
   formula  = gap ~ schoolyear)

gap_yearly_change <- graduation_gaps_lm$coefficients["schoolyear"] %>%
  sprintf("%.2f%%", .)
start_year <- graduation_gaps_lm$model$schoolyear %>% min()
end_year <-  graduation_gaps_lm$model$schoolyear %>% max()

# From 2016 and onwards
graduation_gaps_lm_2016 <- graduation_gaps %>% 
  filter(schoolyear >= 2016) %>%
  lm(data = .,
   formula  = gap ~ schoolyear)
gap_yearly_change_2016 <- graduation_gaps_lm_2016$coefficients["schoolyear"]

gap_yearly_change_2016_txt <- gap_yearly_change_2016 %>%
  sprintf("%.2f%%", .)
  
```


Column 1: Kindergarten Readiness
-----------------------------------------------------------------------

### More kindergarten-ready than Delaware average {data-height=100}

```{r}
valueBox(print_pct(kinder_pct_diff), icon = "fa-child")
```

### Kindergarten Readiness {data-height=500}

```{r}
# Delaware Average 
kinder_plot <- all_kinder %>%
  ggplot(aes(x = year, y = kinder_ready_prop, color = location)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = scales::label_percent()) +
  annotate("text", x = 2020, y = 0.75, label = "WRK",
           color = get_wrk_color("green")) +
  annotate("text", x = 2017, y = 0.625, label = "Delaware",
           color = get_wrk_color("blue")) +
  labs(title = "Children ready for kindergarten",
       x = NULL, y = NULL,
       caption = "Source: KidsCount",
       color = NULL) +
  guides(color = "none") +
  scale_color_manual(values = wrk_pal()(2)) +
  theme_minimal()

# Render the plot
renderPlot({kinder_plot}, res = 85)
```


### Notes {data-height=150}

On average, `r kinder_txt["WRK"]` of children in WRK group were kindergarten ready (2019-2021), compared to `r kinder_txt["Delaware"]` of children in Delaware (2016-2019). The rate of kindergarden readiness in WRK group is `r print_pct(kinder_pct_diff)` more than that of Delaware.


Column 2: Literacy
-----------------------------------------------------------------------

### Improvement in literacy achievement gap to Delaware {data-height=100}

```{r}
# Load Data
ELA <- read_rds(here("data/processed/education_achievement_wide_ELA.rds"))

# Get the eastside
eastside_ELA <- ELA %>%
  select(schoolyear, east_side, delaware) %>%
  mutate(gap = east_side - delaware)

# Linear changes over years (2015-2021)
eastside_ELA_lm <- eastside_ELA %>%
  lm(data = ., formula = gap ~ schoolyear)
# get the year-to-year change
eastside_ELA_gap_coeff <- eastside_ELA_lm$coefficients[["schoolyear"]]

```

```{r}
# Render value box
valueBox(eastside_ELA_gap_coeff %>% sprintf("%+.1f%%/year", .), icon = "fa-book-open")

```


### Literacy Achievement {data-height=500}

```{r}
# Literacy Details Plot
ELA_plot <- eastside_ELA %>%
  ggplot(aes(x = schoolyear, y = gap)) +
  geom_segment(aes(x = schoolyear, xend = schoolyear, y = 0, yend = gap),
               size = 1,
               color = get_wrk_color(palette = "secondary",
                                     colorname = "yellow")) + 
  geom_point(size = 3, 
             color = get_wrk_color(palette = "secondary",
                                     colorname = "yellow")) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = get_wrk_color("blue")) + 
  annotate("text", x = 2016.5, y = 1.5, label = "Delaware Average", 
           color = get_wrk_color("blue")) +
  scale_y_continuous(labels = ~paste0(., "%")) +
  scale_x_continuous(breaks = scales::breaks_pretty()) +
  labs(title = "Literacy achievement gap",
       x = NULL,
       y = NULL,
       caption = "Source: Delaware Open Data \nData points: East Side Charter students.") +
  theme_minimal()

# Render plot
renderPlot({ELA_plot}, res = 80)
```

### Notes {data-height=150}

 

Column 3: Math
-----------------------------------------------------------------------

### Improvement in math achievement gap to Delaware 

```{r}
# Load Data
math <- read_rds(here("data/processed/education_achievement_wide_math.rds"))
# Get the eastside & calculate the gap
eastside_math <- math %>%
  select(schoolyear, east_side, delaware) %>%
  mutate(gap = east_side - delaware)
# Linear changes over years (2015-2021)
eastside_math_lm <- eastside_math %>%
  lm(data = ., formula = gap ~ schoolyear)
# get the year-to-year change
eastside_math_gap_coeff <- eastside_math_lm$coefficients[["schoolyear"]]

```

```{r}
valueBox(eastside_math_gap_coeff %>% sprintf("%+.1f%%/year", .), icon = "fas fa-calculator")

```

### Math Achievement {data-height=500}

```{r}
# Create a plot for math achievement gap
math_plot <- eastside_math %>%
  ggplot(aes(x = schoolyear, y = gap)) +
  geom_segment(aes(x = schoolyear, xend = schoolyear, y = 0, yend = gap),
               size = 1,
               color = get_wrk_color(palette = "secondary", 
                                     colorname = "yellow")) + 
  geom_point(size = 3, 
             color = get_wrk_color(palette = "secondary", 
                                     colorname = "yellow")) +
  geom_hline(yintercept = 0, linetype = "dashed",
             color = get_wrk_color("blue")) + 
  annotate("text", x = 2016.5, y = 1.25,
           label = "Delaware Average", 
           color = get_wrk_color("blue")) +
  scale_y_continuous(labels = ~paste0(., "%")) +
  scale_x_continuous(breaks = scales::breaks_pretty()) +
  labs(title = "Math achievement gap",
       x = NULL,
       y = NULL,
       caption = "Source: Delaware Open Data \nData points: East Side Charter students.") +
  theme_minimal()

renderPlot({math_plot}, res = 80)
```

### Notes {data-height=150}

 

Column 4: Graduation Rate
-----------------------------------------------------------------------

### Improvement in high school graduation gap to Delaware, since 2016 {data-height=100}

```{r}
valueBox(gap_yearly_change_2016 %>% sprintf("%+.1f%%/year", .), icon = "fa-graduation-cap")
```


### Graduation Gap {data-height=500}

```{r}
# Plot the gap with the state average
grad_gap_plot <- graduation_gaps %>%
  mutate(after_2016 = schoolyear >= 2016) %>%
  ggplot(aes(x = schoolyear, y = gap, color = I(plot_color))) +
  geom_smooth(data = subset(graduation_gaps, schoolyear >= 2016),
              method = "lm", se = FALSE,
              color = get_wrk_color("green"),
              linetype = "dotted") + 
  geom_segment(aes(x = schoolyear, xend = schoolyear, y = 0, yend = gap),
               size = 1.2) + 
  geom_point(size = 5) +
  geom_hline(yintercept = 0,
             linetype = "dashed",
             color = get_wrk_color("blue")) + 
  annotate("text", x = 2015, y = 0.25,
           label = "Delaware Average", color = get_wrk_color("blue")) +
  labs(y = NULL,
       x = NULL,
       title = "High school graduation gap") +
  guides(color = "none") +
  scale_y_continuous(labels = ~sprintf("%.1f%%", .), limits = c(NA, NA)) + 
  scale_x_continuous(breaks = scales::breaks_pretty()) +
  labs(caption = "Data source: DE Open Data \n 
                  Data points are the aggregates among Brandywine, Christiana, & Colonial School districts.") +
  theme_minimal() 

renderPlot({grad_gap_plot}, res = 80)
```



### Notes {data-height=150}

- On average, the gaps in the graduation rate with the 
state average worsened by `r gap_yearly_change` per year from `r start_year` to `r end_year`.  

- However, if we focus on 2016 onwards, the gap may be improving. On average, the gap
improved by `r gap_yearly_change_2016_txt` per year from 2016 to 2020.





# Workforce Development {data-orientation=columns}

```{r}
# Load Data
unemployment <- read_rds(here("data/processed/workforce_unemployment.rds"))
unemployment_summary_long <- read_rds(here("data/processed/workforce_unemployment_sum_long.rds"))
unemployment_summary_wide <- read_rds(here("data/processed/workforce_unemployment_sum_wide.rds"))
```

Column 1: Unemployment
-----------------------------------------------------------------------
```{r}
# Unemployment 
unemployment_gaps_lm <- lm(data = unemployment_summary_wide,
                           formula = gap_to_Wilmington ~ year)
unemployment_gaps_yearly_change <- sprintf(fmt = "%.1f%%", unemployment_gaps_lm$coefficients["year"] * 100)
unemployment_start_year <- unemployment_gaps_lm$model$year %>% min()
unemployment_end_year <-  unemployment_gaps_lm$model$year %>% max()
unemployment_gaps_lm_2017 <- unemployment_summary_wide %>%
  filter(year >= 2017) %>%
  lm(data = ., formula = gap_to_Wilmington ~ year)
unemployment_gaps_yearly_change_2017 <- unemployment_gaps_lm_2017$coefficients["year"] * 100
```


### Unemployment gaps to Wilmington, since 2017 {data-height=100}
```{r}
unemployment_box_color <- case_when(unemployment_gaps_yearly_change_2017 >= 0 ~ "warning",
                                    unemployment_gaps_yearly_change_2017 < 0 ~ "success")
unemployment_text <- unemployment_gaps_yearly_change_2017 %>%
  sprintf(fmt = "%+.1f%%", .)
valueBox(unemployment_text, icon = "fa-briefcase",
         color = unemployment_box_color)
```


### &nbsp; {-}
```{r}
# Create the plot for unemployment gap against Wilmington
unemployment_plot <- unemployment_summary_wide %>%   
  ggplot(aes(x = year, y = gap_to_Wilmington)) +
  geom_segment(aes(x = year, 
                   xend = year,
                   y = 0, yend = gap_to_Wilmington),
               size = 1.2,
               color = get_wrk_color("yellow", "secondary")) + 
  geom_point(size = 5, color = get_wrk_color("yellow", "secondary")) +
  geom_hline(yintercept = 0, linetype = "dashed",
             color = get_wrk_color("blue")) +
  annotate("text", label = "Wilmington average", x = 2011.5, y = -0.005,
           color = get_wrk_color("blue")) + 
  labs(y = NULL, x = NULL,
       title = "Gaps in unemployment rate vs. Wilmington",
       color = NULL) +
  scale_y_continuous(labels = scales::label_percent()) + 
  scale_x_continuous(breaks = scales::pretty_breaks()) + 
  labs(caption = "Data source: 5-year ACS") +
  theme_minimal()

# Combine two plots and render
renderPlot({unemployment_plot}, res = 90)
```


### &nbsp; {-}

```{r}
unemployment_rates_plot <- unemployment_summary_long %>%   
  ggplot(aes(x = year, y = unemployed_prop, color = label)) +
  geom_line() + 
  geom_point() +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  scale_y_continuous(labels = scales::label_percent()) +
  labs(color = NULL, x = NULL, y = NULL,
       title = "Unemployment rate",
       caption = "Data source: 5-year ACS") + 
      scale_color_manual(values = wrk_pal()(3))

# Convert to Plotly
unemployment_rates_plot %>%
  ggplotly()
```

### Notes {data-height=150}

- The gaps to the Wilmington's unemployment rate were improving on average
by `r unemployment_gaps_yearly_change` per year from `r unemployment_start_year` to `r unemployment_end_year`

- However, the gaps are worsening since 2017 by `r unemployment_text` per year.


# Housing {data-navmenu="Details" data-icon="fas fa-house-user"}

Inputs {.sidebar}
-----------------------------------------------------------------------
### Outcome
```{r}
selectInput("selectedOutcome", label = NULL, 
            choices = hud_vars)
renderText({
    hud_var_def[[input$selectedOutcome]]
  })
```



```{r}
selectInput("summaryMethod", label = h3("Summary Method"),
            choices = c("Sum" = "sum", "Average" = "mean"))
```

#### Potentially-Relevant Outcomes

- % Occupied
- % Moved past year
- Average months since move-in


Row 1
-----------------------------------------------------------------------

### Delaware
```{r}
renderPlot({
  
  selectedOutcome <- sym(input$selectedOutcome)

  hud_de %>%
    plot_bar(outcome = input$selectedOutcome,
             method = input$summaryMethod,
             y_lab = names(which(hud_vars == input$selectedOutcome)))
  
})
```


### 3 Tracts Combined

```{r}
renderPlot({
  
  selectedOutcome <- sym(input$selectedOutcome)

  hud_de %>%
    filter(code %in% target_tracts) %>%
    plot_bar(outcome = input$selectedOutcome,
             method = input$summaryMethod,
             y_lab = names(which(hud_vars == input$selectedOutcome)))
  
})
```


Row 2
-----------------------------------------------------------------------


### [CT30.02 (Riverside)][CT3002]

```{r}
renderPlot({
  
  selectedOutcome <- sym(input$selectedOutcome)

  hud_de %>%
    filter(code == "10003003002") %>%
    ggplot(aes(x = year, y = !!selectedOutcome)) +
    geom_plot_col +
    ylab(names(which(hud_vars == input$selectedOutcome)))
  
})
```


### [CT 6.01 (Eastlake/Eastlawn)][CT601]

```{r}
renderPlot({
  
  selectedOutcome <- sym(input$selectedOutcome)

  hud_de %>%
    filter(code == "10003000601") %>%
    ggplot(aes(x = year, y = !!selectedOutcome)) +
    geom_plot_col +
    ylab(names(which(hud_vars == input$selectedOutcome)))
  
})
```


### [CT 6.02 (Northeast)][CT602]

```{r}
renderPlot({
  
  selectedOutcome <- sym(input$selectedOutcome)

  hud_de %>%
    filter(code == "10003000602") %>%
    ggplot(aes(x = year, y = !!selectedOutcome)) +
   geom_plot_col +
    ylab(names(which(hud_vars == input$selectedOutcome)))

  
})
```

# Education {data-navmenu="Details" data-icon="fa-graduation-cap" data-orientation=rows}

Row 1
-----------------------------------------------------------------------

### Achievement Details

:::: {#achievement-container .d-flex .flex-row}

::: {#achievement-controls .d-flex .flex-column}
```{r}
# Input
default_contentareas <- c("ELA", "MATH")
selectInput(
  inputId = "contentareas",
  label = "Content Areas", 
  choices = contentareas,
  multiple = TRUE,
  selected = default_contentareas
)

# Select groups
default_groups <- c("State of Delaware", "East Side Charter School")
selectInput(
  inputId = "groups",
  label = "Groups", 
  choices = rev(groups),
  multiple = TRUE,
  selected = default_groups
)

# Select grades to plot, defaults to All Students only
selectInput(
  inputId = "ach_grades",
  label = "Grades",
  choices = c("3rd Grade",
    "4th Grade",
    "5th Grade",
    "6th Grade",
    "7th Grade",
    "8th Grade",
    "All Students"),
  multiple = TRUE,
  selected = "All Students"
)

actionButton("educationReset",
             icon = icon("fas fa-sync"),
             label = "Reset",
             class = "btn btn-secondary btn-sm align-self-center")

# Observe event for action button and reset to default 
observeEvent(input$educationReset, {
  updateSelectInput(session, "contentareas", selected = default_contentareas)
  updateSelectInput(session, "groups", selected = default_groups)
  return (NULL)
})
```
:::


```{r}
output$plot <- renderPlotly({
  plot_achievement(selected_contentarea = input$contentareas,
                   selected_orgs = input$groups,
                   selected_grades = input$ach_grades) %>%
    ggplotly(tooltip = c("y", "x", "colour"), dynamicTicks = FALSE)
})

plotlyOutput("plot")
```


:::: 

Row 2
-----------------------------------------------------------------------

### Graduation rate
```{r}
output$graduation <- renderPlotly({
  out_plot <- graduation %>% 
    ggplot(aes(x = schoolyear, y = pctgraduates,
               color = organization, group = organization)) +
    geom_line() +
    geom_point() +
    facet_grid(. ~ ratetype) +
    scale_y_continuous(labels = ~paste0(., "%")) +
    ylab(NULL) +
    xlab(NULL) + 
    labs(color = NULL) + 
    ggtitle("High school graduation rate")
  
    return(ggplotly(out_plot))
})

plotlyOutput("graduation")
```



<!-- Markdown Links -->

[CT3002]: https://censusreporter.org/profiles/14000US10003003002-census-tract-3002-new-castle-de/
[CT602]: https://censusreporter.org/profiles/14000US10003000602-census-tract-602-new-castle-de/
[CT601]: https://censusreporter.org/profiles/14000US10003000601-census-tract-601-new-castle-de/